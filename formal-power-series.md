---
marp: true
math: mathjax
---


# 形式的冪級数勉強会

### 2025/10/25

Harui (Twitter: @Nutoriaezu88808, GitHub: @Harui-i)

---
# 許して
私は代数をよく知らないこと、体系的にFPSを学んではいないことから、間違いや不適切な表現があるかもしれません。もしあれば、教えていただけると幸いです。

---
# 扱わない内容
- 実装の詳細
  - 色々な計算について、定数倍が速いアルゴリズムがあったり、NTTの高速な実装があったり、色々と面白いトピックはあるんですが、複雑になるので省きます。

---
# 要求する知識

- 多項式の和/差/積について知っている


---
# FPSとは？

数列 $(a_i)_{i=0}^{\infty}$ に対して、$\sum_{i=0}^{\infty} a_i x^i$ と書くものを通常型母関数(Ordinary Generating Function, **OGF**)といいます。

$\sum_{i=0}^{\infty} a_i \frac{x^i}{i!}$ と書くものを指数型母関数(Exponential Generating Function, **EGF**)といいます。

このように、数列に対応する冪級数を考えている、ということを意識することが重要な気がしています。

---
## 例

- 数列 $(3, 1, 4, 1, 5, 9)$に対応するOGFは $3 + 1x + 4x^2 + 1x^3 + 5x^4 + 9x^5$

- 数列 $(3, 1, 4, 1, 5, 9)$に対応するEGFは $3 + 1\frac{x}{1!} + 4\frac{x^2}{2!} + 1\frac{x^3}{3!} + 5\frac{x^4}{4!} + 9\frac{x^5}{5!} = 3 + x + 2x^2 + \frac{x^3}{3!} + \frac{x^4}{4!} + \frac{x^5}{5!}$

---
## いろいろな言葉について

- FPS(Formal Power Series) = 形式的冪級数
- OGF(Ordinary Generating Function) = 通常型母関数
- EGF(Exponential Generating Function) = 指数型母関数

---
# 形式的冪級数の演算や性質

ここでは、数列のことは一旦忘れて、FPSの演算や性質について扱います。　なので、数列→FPSの対応付けの違いであるOGF/EGFの違いは一旦忘れても大丈夫です。

FPSの和/差/積/微分/積分は、通常の多項式と同じように定義されます。

## 和/差/積
$f = \sum_{i=0}^{\infty} a_i x^i, g = \sum_{i=0}^{\infty} b_i x^i$ としたとき、

$$ f+g = \sum_{i=0}^{\infty} (a_i + b_i) x^i $$

$$ fg = \sum_{i=0}^{\infty} \left( \sum_{j=0}^{i} a_j b_{i-j} \right) x^i $$

---
## 微分

極限を考えているわけではなく、こういう操作に微分という名前をつけているだけです。

$$ f' = \sum_{i=1}^{\infty} i a_i x^{i-1} $$

---
## 逆元
ここからはおそらく新しい演算に見えると思います。
係数は $\mathbb{Q}$ や $\mathbb{F}_{998244353}$ のような体上であるとします。

$f = \sum_{i=0}^{\infty} a_i x^i$ に対して、$g = \sum_{i=0}^{\infty} b_i x^i$ を $fg = 1$ (この右辺の $1$ は $(1, 0, 0, \ldots)$ に対応するFPS) を満たすような $g$を、$f$ の逆元と呼びます。

$f$の逆元は、$a_0 \neq 0$なら一意に存在して、そうでないと存在しません。(証明略)(逆元を手計算で計算する方法をしれば、この条件は納得できると思います)

---
### 逆元の計算方法・例

$f = 1 - x$ の逆元 $g = \sum_{i=0}^{\infty} b_i x^i$ を求めます。

$fg = 1$ と、 $fg = (1-x)g = g - xg = \sum_{i=0}^{\infty} b_i x^i - \sum_{i=0}^{\infty} b_i x^{i+1} = b_0 + \sum_{i=1}^{\infty} (b_i - b_{i-1}) x^i$ から、$b_0 = 1, \space b_i = b_{i-1} (i \geq 1)$

がわかるので、$g = \sum_{i=0}^{\infty} 1 x^i = 1 + x + x^2 + x^3 + \ldots$ となります。

つまり、

$$ 1 = (1-x)(1 + x + x^2 + x^3 + \ldots )$$

こういう意味で、
$$ \frac{1}{1-x} = 1 + x + x^2 + x^3 + \ldots $$

と書いている気がします(要出展)

---
### 逆元の手計算

$1-x$の逆元が$1 + x + x^2 + \ldots$であるのは知っている思いますが、$1 - \frac{x^2}{6} + \frac{x^4}{120}$ の逆元を手計算で求めるときは、ふつうに筆算をすればよいです(定義とも一致します)。

--- 
## ここまでの演算について(仮)


ここまでの定義より、**和/差/積/逆元の演算の$N$項目までは、元のFPSの$N$項目までの係数から計算できます。**

なので、FPSの定義では無限の項数が出てきますが、実際に計算したいFPSの$N$項目を求めるときは有限の計算で求められます。

---
## exp

$f = \sum_{i=0}^{\infty} a_i x^i$ (ただし、$a_0 = 0$)に対して、

$$ \exp(f) = \sum_{i=0}^{\infty} \frac{f^i}{i!} $$
とします。 $a_0 \neq 0$ の場合、$\exp(f)$の$0$次の項に$f$の係数の無限和が現れてしまいかなり「気ぃ悪い」ことになります。
(たとえば、FPSの性質である和/差/積の$n$次目までの係数が、$n$次目までの係数だけで決まる、という性質が崩れます)


---
### expの性質

- $\exp(f+g) = \exp(f)\exp(g)$
- $(\exp(f))' = f' \exp(f)$


---
## log
$f = \sum_{i=0}^{\infty} a_i x^i$ (ただし、$a_0 = 1$)に対して、
$$ \log(f) = \sum_{i=1}^{\infty} (-1)^{i-1} \frac{(f-1)^i}{i} $$
とします。 $a_0 \neq 1$ の場合、$\log(f)$の$0$次の項に$f$の係数の無限和が現れてしまいかなり「気ぃ悪い」ことになります。
(たとえば、FPS性質である和/差/積の$n$次目までの係数が、$n$次目までの係数だけで決まる、という性質が崩れます)

---
## logの性質

TODO: 書く
- $(\log f)' = \dfrac{f'}{f}$
- $\log(fg) = \log f + \log g$

---
## 微分の嬉しい性質(OGF)
$f = \sum_{i=0}^{\infty} a_i x^i$ のとき、

$$xf' = \sum_{i=0}^{\infty} i a_i x^i$$

つまり、OGFにおいて、微分して$x$をかける操作は、数列の各項にそのインデックスをかける操作に対応します。


---
## 微分の嬉しい性質(EGF)
$f = \sum_{i=0}^{\infty} a_i \frac{x^i}{i!}$ のとき、
$$f' = \sum_{i=0}^{\infty} a_{i+1} \frac{x^i}{i!}$$
つまり、EGFにおいて、微分する操作は、数列の各項を一つ前にずらす操作に対応します。


---
## 累積和(OGF)

$f = \sum_{i=0}^{\infty} a_i x^i$ のとき、
$$ \frac{f}{1-x} = \sum_{i=0}^{\infty} \left( \sum_{j=0}^{i} a_j \right) x^i $$

つまり、OGFにおいて、$\frac{1}{1-x}$をかける操作は、数列の累積和をとる操作に対応します。

---
## OGFの積
(あたりまえかも)

$f = \sum_{i=0}^{\infty} a_i x^i, g = \sum_{i=0}^{\infty} b_i x^i$ のとき、

$$fg = \sum_{i=0}^{\infty} \left( \sum_{j=0}^{i} a_j b_{i-j} \right) x^i $$


---
## OGFの積(続き)
$f = \sum_{i=0}^{\infty} a_i x^i, g = \sum_{i=0}^{\infty} b_i x^i, h = \sum_{i=0}^{\infty} c_i x^i$ としたとき

$$fgh = \sum_{i=0}^{\infty} x^i \sum_{i_1 + i_2 + i_3 = i}  a_{i_1} b_{i_2} c_{i_3}$$


もっと一般に3個以上のOGFの積についても同様で、$x^i$の係数には、次数和が$i$であるような各項の選び型についての係数の積の総和が現れる。


---
## OGFの積の例(重複組み合わせ, 負の二項定理)

TODO: kaku

---
## EGFの積

$f = \sum_{i=0}^{\infty} a_i \frac{x^i}{i!}, g = \sum_{i=0}^{\infty} b_i \frac{x^i}{i!}$ のとき、

$$ fg = \sum_{i=0}^{\infty} \left( \sum_{j=0}^{i} \binom{i}{j} a_j b_{i-j} \right) \frac{x^i}{i!} $$

つまり、 $(c_i)_{i=0}^{\infty}$の母関数が$fg$であるとき、$c_i = \sum_{j=0}^{i} \binom{i}{j} a_j b_{i-j}$ となる。


---
## EGFの積(続き)

$f = \sum_{i=0}^{\infty} a_i \frac{x^i}{i!}$, $g = \sum_{i=0}^{\infty} b_i \frac{x^i}{i!}$, $h = \sum_{i=0}^{\infty} c_i \frac{x^i}{i!}$ としたとき

$$fgh = \sum_{i=0}^{\infty} \frac{x^i}{i!} \sum_{i_1 + i_2 + i_3 = j} \frac{i!}{i_1! i_2! i_3!} a_{i_1} b_{i_2} c_{i_3}$$

となる。3個以上のときも同様で、EGFの積の数列の$i$項目には、和が$i$となるような次数の選び方について、多項係数の重みつきの係数の積の総和が現れる。


---
# FPSを使って問題を解く
## ABC 178 D - Redistribution

> 整数 $S$ が与えられます。すべての項が$3$以上の整数で、その総和が$S$であるような数列がいくつあるか求めてください $\pmod {10^9 + 7}$

$f = x^3 + x^4 + x^5 + \ldots$ とすると、 $f + f^2 + f^3 + \ldots$ の $x^S$ の係数が答え。
$$1 + f + f^2 + f^3 + \ldots = \frac 1 {1-f}, \space f = \frac {x^3}{1-x}$$
なので、「$x^3$に$1-x$の逆元をかけて、マイナス1倍してそれに1を足したものの逆元」を計算すれば求められる。
(実は $\frac 1 {1-f} = \frac{1}{1 - \frac{x^3}{1-x}} = \frac {1-x}{1-x-x^3}$ なので、もっと簡単になる。母関数が有理関数なので線形漸化式があり、それを計算すればもっと単純になる)

u
## 積の和典型
> 長さが$N$、各要素が$1$以上$M$以下の整数列 $(a_1, a_2, \ldots, a_N)$ であって、和が$M$であるような全ての数列について$\prod_{i}{a_i}$を求めて、その総和求めよ。

$f = x + 2x^2 + 3x^3 + \ldots$ とすると、求める和は $f^N$ の $x^M$ の係数である。

お気持ち: 一つの項で$i$を選ぶと、数列の和が$i$増え、積には$i$がかかる。$i$としては$1$から$M$まで選べるので、$1 \cdot x + 2 \cdot x^2 + \ldots + M \cdot x^M$ に対応している感じがする。和が$M$な正の整数列にだけ興味があるので、$M$次より大きな項を付け足してもいい。これを$N$回選ぶので、$f^N$の$x^M$の係数を求めればよい。

---
## 積の和典型(続き)
> 長さが$N$、各要素が$1$以上$M$以下の整数列 $(a_1, a_2, \ldots, a_N)$ であって、和が$M$であるような全ての数列について$\prod_{i}{a_i}$を求めて、その総和求めよ。

$f^N = (x(\frac{1}{1-x})')^N = (x(1-x)^{-2})^N = (\frac{x}{(1-x)^2})^N$ であり、 実は $(1-x)^{-K} = \sum_{i=0}^{\infty} \binom{i+K-1}{K-1} x^i$ なので、二項係数さえもとまっていれば、$f^N$の$M$次の係数は$\Theta(1)$ で計算できる。 

$(1-x)^{-K}$の$i$次の係数が二項係数で表せる理由: 区別する$K$個の箱に、区別しない$i$個の玉を入れる方法の数え上げ(玉と仕切りを考えるやつ)なので、$K$個の玉と$i-1$個の仕切りを並べる方法の数え上げに対応するから。



---
## 積の和典型(続き)

積の和典型あるあるとして「掛けたいものを係数に持ってきて、和を取りたいものを指数に持ってきがち」というのがある

---
## 積の和典型の例
### ABC XXX Bolls in Boxes

(TODO: kaku)

---
<!-- ↓ここを最後のスライドとしたい-->
# 参考文献

- https://codeforces.com/blog/entry/77468
  - OGF/EGFの定義からいろいろな性質まで扱っている(英語)
- https://trap.jp/post/1657/
    - traPのFPSの講習会の資料。計算方法や、問題を手計算で解く方法などが詳しく書かれている。

- https://maspypy.com/多項式・形式的べき級数数え上げとの対応付け
    - FPSで数え上げ問題を解く方法について。 (2)や(3)も参考になる。